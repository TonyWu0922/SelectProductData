<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>æŸ¥è©¢ç”¢å“åç¨±</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 1rem;
    }

    video {
      width: 100%;
      max-width: 480px;
      margin: 1rem auto;
      border: 1px solid #ccc;
    }

    .result {
      margin-top: 1rem;
      font-size: 1.2rem;
    }

    .scanner-container {
      position: relative;
      display: inline-block;
      width: 100%;
      max-width: 480px;
    }

    .scan-line {
      position: absolute;
      top: 50%;
      left: 0;
      width: 100%;
      height: 2px;
      background: red;
      animation: scanAnim 2s infinite;
    }

    @keyframes scanAnim {
      0% {
        top: 0%;
      }

      50% {
        top: 50%;
      }

      100% {
        top: 0%;
      }
    }

    #scanButton {
      margin-top: 20px;
    }
  </style>
</head>

<body>
  <h2>ğŸ“¦ æŸ¥è©¢ç”¢å“åç¨±</h2>

  <input type="file" id="excelFile" accept=".xlsx" />
  <div class="scanner-container">
    <video id="video" autoplay muted playsinline></video>
    <div class="scan-line"></div>
  </div>

  <div class="result">
    <h3>æƒæçµæœ</h3>
    <p><strong>å“è™Ÿ:</strong> <span id="itemCode">æœªæƒæ</span></p>
    <p><strong>å“å:</strong> <span id="itemName">æœªæƒæ</span></p>
  </div>

  <button id="scanButton" style="display:none;">å†æ¬¡æƒæ</button>

  <script type="module">
    import { read, utils } from 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/+esm';
    import { BrowserMultiFormatReader } from 'https://cdn.jsdelivr.net/npm/@zxing/browser@0.0.10/+esm';

    const video = document.getElementById('video');
    const excelFile = document.getElementById('excelFile');
    const itemCodeElement = document.getElementById('itemCode');
    const itemNameElement = document.getElementById('itemName');
    const scanButton = document.getElementById('scanButton');
    let barcodeMap = {};
    let isScanning = true;  // æ¨™è¨˜æ˜¯å¦åœ¨æƒæä¸­

    // æ‰‹å‹•å®šç¾© DecodeHintTypeï¼ˆzxing æ²’æœ‰ç›´æ¥åŒ¯å‡ºï¼‰
    const DecodeHintType = {
      POSSIBLE_FORMATS: 2
    };

    // è®€å– Excel æª”
    excelFile.addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (!file) return;

      try {
        const arrayBuffer = await file.arrayBuffer();
        const workbook = read(arrayBuffer, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const data = utils.sheet_to_json(sheet);

        barcodeMap = {};
        data.forEach(row => {
          const barcode = row['æ¢ç¢¼ç·¨è™Ÿ'];
          if (barcode) {
            barcodeMap[barcode.toString()] = {
              itemCode: row['å“è™Ÿ'] || '',
              itemName: row['å“å'] || ''
            };
          }
        });

        alert('âœ… å•†å“è³‡æ–™å·²è¼‰å…¥ï¼Œè«‹é–‹å§‹æƒæï¼');
        startScan();
      } catch (err) {
        alert("âŒ è®€å– Excel æª”å¤±æ•—ï¼š" + err.message);
      }
    });

    function updateScanResult(barcode) {
      const matched = barcodeMap[barcode];
      if (matched) {
        itemCodeElement.textContent = matched.itemCode;
        itemNameElement.textContent = matched.itemName;
      } else {
        itemCodeElement.textContent = "æœªçŸ¥";
        itemNameElement.textContent = "æœªæ‰¾åˆ°è³‡æ–™";
      }
    }

    function startScan() {
      if (!isScanning) return;  // å¦‚æœå·²ç¶“åœ¨æƒæä¸­ï¼Œå‰‡è¿”å›

      const codeReader = new BrowserMultiFormatReader();

      // æŸ¥æ‰¾å¯ç”¨çš„è¦–é »è¨­å‚™
      navigator.mediaDevices.enumerateDevices().then(devices => {
        const videoDevices = devices.filter(device => device.kind === 'videoinput');
        if (videoDevices.length === 0) {
          alert("âŒ æ‰¾ä¸åˆ°æ”åƒé ­è¨­å‚™");
          return;
        }

        const videoDeviceId = videoDevices[0].deviceId;  // ä½¿ç”¨ç¬¬ä¸€å€‹å¯ç”¨çš„æ”åƒé ­è¨­å‚™

        const hints = new Map();
        hints.set(DecodeHintType.POSSIBLE_FORMATS, [
          'EAN_13', 'UPC_A', 'UPC_E', 'EAN_8', 'CODE_128', 'CODE_39', 'ITF', 'CODE_93'
        ]);

        codeReader.decodeFromVideoDevice(videoDeviceId, video, (result, err) => {
          if (result) {
            const barcode = result.getText();
            const format = result.getBarcodeFormat();

            // åªè™•ç†ç‰¹å®šçš„ä¸€ç¶­æ¢ç¢¼æ ¼å¼
            if (['EAN_13', 'UPC_A', 'UPC_E', 'EAN_8', 'CODE_128', 'CODE_39', 'ITF', 'CODE_93'].includes(format.toString())) {
              updateScanResult(barcode);
              console.log("æƒæåˆ°æ¢ç¢¼ï¼š" + barcode);

              // åœæ­¢æƒæä¸¦é¡¯ç¤ºã€Œå†æ¬¡æƒæã€æŒ‰éˆ•
              isScanning = false;
              scanButton.style.display = 'inline-block';  // é¡¯ç¤ºã€Œå†æ¬¡æƒæã€æŒ‰éˆ•
            } else {
              console.log("éä¸€ç¶­æ¢ç¢¼ï¼Œè·³éæ­¤æ¢ç¢¼ã€‚");
            }
          } else if (err) {
            // å¦‚æœå‡ºç¾éŒ¯èª¤ï¼Œä½†ä¸¦éå› ç‚ºæ¢ç¢¼ä¸å­˜åœ¨ï¼Œå¯ä»¥ç¹¼çºŒæƒæ
            if (!(err instanceof NotFoundException)) {
              console.log("æƒæéŒ¯èª¤:", err);
            }
          }
        }, hints);
      }).catch(error => {
        console.error("ç²å–æ”åƒé ­è¨­å‚™åˆ—è¡¨å¤±æ•—:", error);
        alert("âŒ ç„¡æ³•è¨ªå•æ”åƒé ­è¨­å‚™");
      });
    }

    // é»æ“Šã€Œå†æ¬¡æƒæã€æŒ‰éˆ•å¾Œï¼Œæ¢å¾©æƒæç‹€æ…‹
    scanButton.addEventListener('click', () => {
      itemCodeElement.textContent = "æœªæƒæ";
      itemNameElement.textContent = "æœªæƒæ";
      scanButton.style.display = 'none';  // éš±è—ã€Œå†æ¬¡æƒæã€æŒ‰éˆ•
      isScanning = true;  // æ¢å¾©æƒæ
      startScan();  // é‡æ–°é–‹å§‹æƒæ
    });
  </script>
</body>

</html>